<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>簡單表單</title>
</head>
<body>
  <h2>新增訂單</h2>
  
  <label for="pname">商品：</label>
  <select id="pname"></select>

  <label for="cname">會員：</label>
  <select id="cname"></select>

  <label for="sname">運送者：</label>
  <select id="sname"></select>

  <!-- 👇 數量欄位已移除 -->
  <!-- <label for="num">數量：</label>
  <input type="text" id="num"> -->

  <button onclick="insertpost()">新增</button>

  <script>
    const apiCustomer = 'http://localhost:8000/api/1/member';
    const apiProduct = 'http://localhost:8000/api/1/product2';
    const apiShipper = 'http://localhost:8000/api/1/employee';
    const cname = document.getElementById("cname");
    const pname = document.getElementById("pname");
    const sname = document.getElementById("sname");

    async function cnameAdd() {
      try {
        const resp = await fetch(apiCustomer);
        const data = await resp.json();

        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- 請選擇會員 --";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        cname.append(defaultOption);

        data.forEach(row => {
          const id = row["idmember"];
          const name = row["membername"];
          const op = document.createElement("option");

          op.value = id;
          op.textContent = `${id} - ${name}`;
          cname.append(op);
        });
      } catch (err) {
        console.error("客戶資料載入失敗", err);
      }
    }

    async function pnameAdd() {
      try {
        const resp = await fetch(apiProduct);
        if (!resp.ok) throw new Error(`HTTP 錯誤: ${resp.status}`);
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) return;

        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- 請選擇商品 --";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        pname.append(defaultOption);

        data.forEach(row => {
          const id = row["idproduct2"];
          const distance = row["distance"];
          const weight = row["weight"];
          const price = row["price"];
          const op = document.createElement("option");

          op.value = id;
          op.textContent = `${id} - 長度: ${distance}, 重量: ${weight}, 價格: ${price}`;
          pname.append(op);
        });
      } catch (err) {
        console.error("商品資料載入失敗", err);
      }
    }

    async function snameAdd() {
      try {
        const resp = await fetch(apiShipper);
        const data = await resp.json();

        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- 請選擇運送者 --";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        sname.append(defaultOption);

        data.forEach(row => {
          const id = row["idemployee"];
          const name = row["employeeName"];
          const op = document.createElement("option");

          op.value = id;
          op.textContent = `${id} - ${name}`;
          sname.append(op);
        });
      } catch (err) {
        console.error("運送者資料載入失敗", err);
      }
    }

    cnameAdd();
    pnameAdd();
    snameAdd();

    function insertpost() {
      const pnameValue = document.getElementById("pname").value;
      const cnameValue = document.getElementById("cname").value;
      const snameValue = document.getElementById("sname").value;

      if (pnameValue && cnameValue && snameValue) {
        const returnbody = JSON.stringify({
          table: "orders",
          pname: pnameValue,
          cname: cnameValue,
          sname: snameValue
        });

        console.log(returnbody);

        fetch('http://localhost:8000/api/2/insert', {
          method: 'POST',
          mode: 'cors',
          body: returnbody,
        });

        console.log("完成fetch");
      } else {
        alert("請輸入資料");
      }
    }
  </script>
</body>
</html>
